version: "3.0"

set: ['e', 'u', 'pipefail']
shopt: ['globstar']

env:
  JAVA_HOME: '{{.JAVA_HOME | default "/opt/homebrew/opt/openjdk@21"}}'
  ANDROID_HOME: '{{.ANDROID_HOME | default "/opt/homebrew/share/android-commandlinetools"}}'
  ANDROID_NDK_HOME: '{{.ANDROID_NDK_HOME | default "/opt/homebrew/share/android-commandlinetools/ndk/28.2.13676358"}}'
  NDK_HOME: '{{.NDK_HOME | default "/opt/homebrew/share/android-commandlinetools/ndk/28.2.13676358"}}'
  GOOGLE_PLAY_TRACK: '{{.GOOGLE_PLAY_TRACK | default "alpha"}}'

vars:
  TAURI_DIR: "{{.ROOT_DIR}}/src-tauri"
  ANDROID_EMULATOR: '{{.ANDROID_EMULATOR | default "pixel_7"}}'
  ANDROID_AVD_DIR: '{{.HOME}}/.android/avd'
  ANDROID_ARM64_TARGET: "aarch64-linux-android"
  ANDROID_ARMV7_TARGET: "armv7-linux-androideabi"
  ANDROID_X86_TARGET: "i686-linux-android"
  ANDROID_X64_TARGET: "x86_64-linux-android"

tasks:
  debug:
    cmds:
      - printenv | grep ANDROID_
    silent: true

  setup:
    desc: "Install Android development dependencies"
    env:
      JAVA_HOME: /opt/homebrew/opt/openjdk@21
      PATH: /opt/homebrew/opt/openjdk@21/bin:{{.PATH}}
    cmds:
      - |
        echo "Installing JDK and Android SDK..."
        for pkg in openjdk@21 android-commandlinetools; do
          brew list "$pkg" &>/dev/null || brew install "$pkg"
        done
      - |
        echo "Installing Android NDK..."
        yes | sdkmanager --install "ndk;28.2.13676358"
      - |
        echo "Adding Android Rust targets..."
        rustup target add {{.ANDROID_ARM64_TARGET}} {{.ANDROID_ARMV7_TARGET}} {{.ANDROID_X86_TARGET}} {{.ANDROID_X64_TARGET}}
      - |
        echo "Android setup complete!"
        echo "Add these to your shell profile:"
        echo '  export JAVA_HOME="/opt/homebrew/opt/openjdk@21"'
        echo '  export PATH="$JAVA_HOME/bin:$PATH"'
        echo '  export ANDROID_HOME="/opt/homebrew/share/android-commandlinetools"'
        echo '  export ANDROID_NDK_HOME="$ANDROID_HOME/ndk/28.2.13676358"'
        echo '  export NDK_HOME="$ANDROID_NDK_HOME"'
        echo '  export PATH="$ANDROID_HOME/platform-tools:$ANDROID_HOME/cmdline-tools/latest/bin:$PATH"'
    silent: true

  keystore:setup:
    desc: "Generate keystore.properties from environment variables"
    vars:
      KEYSTORE_PROPS: "{{.TAURI_DIR}}/gen/android/keystore.properties"
    preconditions:
      - sh: test -n "$ANDROID_KEYSTORE_PASSWORD"
        msg: "ANDROID_KEYSTORE_PASSWORD environment variable is not set"
      - sh: test -n "$ANDROID_KEYSTORE_PATH"
        msg: "ANDROID_KEYSTORE_PATH environment variable is not set"
      - sh: test -f "$ANDROID_KEYSTORE_PATH"
        msg: "Keystore file not found at $ANDROID_KEYSTORE_PATH"
    cmds:
      - |
        cat > "{{.KEYSTORE_PROPS}}" <<EOF
        keyAlias=lunch
        password=$ANDROID_KEYSTORE_PASSWORD
        storeFile=$ANDROID_KEYSTORE_PATH
        EOF
        echo "Created {{.KEYSTORE_PROPS}}"
    silent: true

  init:
    desc: "Initialize Android project"
    deps: [":npm:install"]
    cmds:
      - |
        echo "Adding Android Rust targets..."
        rustup target add {{.ANDROID_ARM64_TARGET}} {{.ANDROID_ARMV7_TARGET}} {{.ANDROID_X86_TARGET}} {{.ANDROID_X64_TARGET}}
        echo "Initializing Android project..."
        cd {{.TAURI_DIR}} && npx tauri android init
    status:
      - test -d {{.TAURI_DIR}}/gen/android
    silent: true

  emulator:keyboard:
    desc: "Enable hardware keyboard for emulator (use host keyboard instead of virtual)"
    vars:
      AVD_CONFIG: '{{.ANDROID_AVD_DIR}}/{{.ANDROID_EMULATOR}}.avd/config.ini'
    preconditions:
      - sh: test -f "{{.AVD_CONFIG}}"
        msg: |
          AVD config not found: {{.AVD_CONFIG}}
          Create emulator '{{.ANDROID_EMULATOR}}' in Android Studio or run:
            avdmanager create avd -n {{.ANDROID_EMULATOR}} -k "system-images;android-34;google_apis;arm64-v8a"
    status:
      - grep -q "^hw.keyboard=yes" "{{.AVD_CONFIG}}"
      - grep -q "^hw.keyboard.lid=no" "{{.AVD_CONFIG}}"
    cmds:
      - sed -i '' '/^hw\.keyboard *=/d' "{{.AVD_CONFIG}}"
      - sed -i '' '/^hw\.keyboard\.lid *=/d' "{{.AVD_CONFIG}}"
      - echo "hw.keyboard=yes" >> "{{.AVD_CONFIG}}"
      - echo "hw.keyboard.lid=no" >> "{{.AVD_CONFIG}}"
      - echo "Hardware keyboard enabled for {{.ANDROID_EMULATOR}}"
    silent: true

  emulator:hide-soft-keyboard:
    desc: "Hide soft keyboard when hardware keyboard is connected (run while emulator is running)"
    preconditions:
      - sh: adb devices | grep -q "emulator"
        msg: "No running emulator found. Start one with: task android:dev"
    status:
      - test "$(adb shell settings get secure show_ime_with_hard_keyboard)" = "0"
    cmds:
      - adb shell settings put secure show_ime_with_hard_keyboard 0
      - echo "Soft keyboard hidden (hardware keyboard mode)"
    silent: true

  emulator:setup:
    desc: "Configure emulator for development (keyboard config always, soft keyboard if emulator running)"
    cmds:
      - task: emulator:keyboard
      - |
        if adb devices | grep -q "emulator"; then
          task android:emulator:hide-soft-keyboard
        else
          echo "Emulator not running - soft keyboard will be configured on next 'task android:dev'"
        fi
    silent: true

  dev:
    desc: "Run on Android emulator"
    deps: [":npm:install", "init", "emulator:keyboard"]
    env:
      ANDROID_EMULATOR_WAIT_TIME_BEFORE_KILL: "0"
    cmds:
      - defer: |
          pkill -f "tauri android dev" 2>/dev/null || true
          pkill -9 -f "qemu-system-aarch64" 2>/dev/null || true
      - |
        (
          while ! adb devices | grep -q "emulator"; do sleep 1; done
          adb wait-for-device
          sleep 2
          if [ "$(adb shell settings get secure show_ime_with_hard_keyboard)" != "0" ]; then
            adb shell settings put secure show_ime_with_hard_keyboard 0
            echo "Soft keyboard auto-hidden"
          fi
        ) &
      - cmd: cd {{.TAURI_DIR}} && npx tauri android dev "{{.ANDROID_EMULATOR}}" --host
        ignore_error: true
    interactive: true
    silent: true

  run:emulator:
    desc: "Build release APK and install on emulator (no hot-reload, for testing)"
    deps: [":npm:install", "init", "emulator:keyboard"]
    vars:
      APK_DIR: "{{.TAURI_DIR}}/gen/android/app/build/outputs/apk/universal/release"
      RELEASE_APK: "{{.TAURI_DIR}}/gen/android/app/build/outputs/apk/universal/release/app-universal-release.apk"
      UNSIGNED_APK: "{{.TAURI_DIR}}/gen/android/app/build/outputs/apk/universal/release/app-universal-release-unsigned.apk"
      SIGNED_APK: "{{.TAURI_DIR}}/gen/android/app/build/outputs/apk/universal/release/app-universal-release-signed.apk"
      DEBUG_KEYSTORE: "{{.HOME}}/.android/debug.keystore"
      APKSIGNER: "{{.ANDROID_HOME}}/build-tools/35.0.0/apksigner"
    cmds:
      - |
        # Start emulator if not running
        if ! adb devices | grep -q "emulator"; then
          echo "Starting emulator..."
          "{{.ANDROID_HOME}}/emulator/emulator" -avd "{{.ANDROID_EMULATOR}}" &
          while ! adb devices | grep -q "emulator"; do sleep 1; done
          adb wait-for-device
          sleep 5
        fi
      - cd {{.TAURI_DIR}} && npx tauri android build --apk true --aab false
      - |
        # Use already-signed release APK if available, otherwise sign unsigned APK with debug key
        if [ -f "{{.RELEASE_APK}}" ]; then
          APK="{{.RELEASE_APK}}"
        elif [ -f "{{.UNSIGNED_APK}}" ]; then
          echo "Signing unsigned APK..."
          rm -f "{{.SIGNED_APK}}"
          "{{.APKSIGNER}}" sign --ks "{{.DEBUG_KEYSTORE}}" --ks-pass pass:android --out "{{.SIGNED_APK}}" "{{.UNSIGNED_APK}}"
          APK="{{.SIGNED_APK}}"
        else
          echo "ERROR: No APK found in {{.APK_DIR}}"
          ls -la "{{.APK_DIR}}" || true
          exit 1
        fi
        echo "Installing APK..."
        if ! adb -s emulator-5554 install -r "$APK" 2>&1; then
          echo "Install failed, uninstalling existing app and retrying..."
          adb -s emulator-5554 uninstall com.lunch.app || true
          adb -s emulator-5554 install -r "$APK"
        fi
        adb -s emulator-5554 shell am start -n com.lunch.app/com.lunch.desktop.MainActivity
    silent: true

  dev:device:
    desc: "Run on physical Android device (dev mode with hot-reload)"
    deps: [":npm:install", "init"]
    cmds:
      - defer: pkill -f "tauri android dev" 2>/dev/null || true
      - cmd: cd {{.TAURI_DIR}} && npx tauri android dev --host
        ignore_error: true
    interactive: true
    silent: true

  run:device:
    desc: "Build release APK, sign with debug key, and install on physical Android device"
    deps: [":npm:install", "init"]
    vars:
      UNSIGNED_APK: "{{.TAURI_DIR}}/gen/android/app/build/outputs/apk/universal/release/app-universal-release-unsigned.apk"
      SIGNED_APK: "{{.TAURI_DIR}}/gen/android/app/build/outputs/apk/universal/release/app-universal-release-signed.apk"
      DEBUG_KEYSTORE: "{{.HOME}}/.android/debug.keystore"
      APKSIGNER: "{{.ANDROID_HOME}}/build-tools/35.0.0/apksigner"
    cmds:
      - cd {{.TAURI_DIR}} && npx tauri android build --apk true --aab false
      - |
        rm -f "{{.SIGNED_APK}}"
        "{{.APKSIGNER}}" sign --ks "{{.DEBUG_KEYSTORE}}" --ks-pass pass:android --out "{{.SIGNED_APK}}" "{{.UNSIGNED_APK}}"
        adb install -r "{{.SIGNED_APK}}"
        adb shell am start -n com.lunch.app/com.lunch.desktop.MainActivity
    silent: true

  build:
    desc: "Build for Android distribution (APK and AAB)"
    deps: [":npm:install", "init"]
    cmds:
      - cd {{.TAURI_DIR}} && npx tauri android build
    silent: true

  build:apk:
    desc: "Build APK only (for testing/sideloading)"
    deps: [":npm:install", "init"]
    cmds:
      - cd {{.TAURI_DIR}} && npx tauri android build --apk true --aab false
    silent: true

  build:aab:
    desc: "Build AAB only (for Google Play)"
    deps: [":npm:install", "init"]
    cmds:
      - cd {{.TAURI_DIR}} && npx tauri android build --apk false --aab true
    silent: true

  verify:
    desc: "Verify AAB signature"
    vars:
      AAB: "{{.TAURI_DIR}}/gen/android/app/build/outputs/bundle/universalRelease/app-universal-release.aab"
    preconditions:
      - sh: test -f "{{.AAB}}"
        msg: "AAB not found. Run 'task android:build:aab' first."
    cmds:
      - jarsigner -verify "{{.AAB}}"
    silent: true

  internal:
    desc: "Build and upload to Google Play internal testing track"
    deps: [":npm:install", "init", ":tauri:icons", ":bundle:install"]
    sources:
      - "{{.TAURI_DIR}}/src/**/*.rs"
      - "{{.TAURI_DIR}}/Cargo.toml"
      - "{{.TAURI_DIR}}/Cargo.lock"
      - "{{.TAURI_DIR}}/tauri.conf.json"
      - "{{.TAURI_DIR}}/dist/**/*"
      - "{{.TAURI_DIR}}/icons/icon.png"
      - "{{.ROOT_DIR}}/fastlane/Fastfile"
      - "{{.ROOT_DIR}}/fastlane/Appfile"
    generates:
      - "{{.TAURI_DIR}}/gen/android/app/build/outputs/bundle/release/*.aab"
    method: checksum
    cmds:
      - bundle exec fastlane android internal
    silent: true

  testflight:
    desc: "Build and upload to Google Play beta track"
    deps: [":npm:install", "init", ":tauri:icons", ":bundle:install"]
    sources:
      - "{{.TAURI_DIR}}/src/**/*.rs"
      - "{{.TAURI_DIR}}/Cargo.toml"
      - "{{.TAURI_DIR}}/Cargo.lock"
      - "{{.TAURI_DIR}}/tauri.conf.json"
      - "{{.TAURI_DIR}}/dist/**/*"
      - "{{.TAURI_DIR}}/icons/icon.png"
      - "{{.ROOT_DIR}}/fastlane/Fastfile"
      - "{{.ROOT_DIR}}/fastlane/Appfile"
    generates:
      - "{{.TAURI_DIR}}/gen/android/app/build/outputs/bundle/release/*.aab"
    method: checksum
    cmds:
      - bundle exec fastlane android beta
    silent: true

  release:
    desc: "Build and upload to Google Play production"
    deps: [":bundle:install"]
    cmds:
      - bundle exec fastlane android release
    silent: true

  clean:
    desc: "Clean Android build artifacts"
    cmds:
      - rm -rf {{.TAURI_DIR}}/gen/android/build
      - rm -rf {{.TAURI_DIR}}/gen/android/app/build
      - rm -rf {{.TAURI_DIR}}/gen/android/.gradle
    silent: true
