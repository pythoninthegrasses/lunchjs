version: "3.0"

set: ['e', 'u', 'pipefail']
shopt: ['globstar']

env:
  CARGO_HOME: "{{.ROOT_DIR}}/.cache/cargo"
  CARGO_TARGET_DIR: "{{.ROOT_DIR}}/src-tauri/target"

vars:
  APP_NAME: '{{.APP_NAME | default "Lunch"}}'
  APP_VERSION: '{{.APP_VERSION | default "0.9.0"}}'
  BUNDLE_ID: '{{.BUNDLE_ID | default "com.lunch.desktop"}}'
  TAURI_DIR: "{{.ROOT_DIR}}/src-tauri"
  MACOS_ARM64_TARGET: "aarch64-apple-darwin"
  MACOS_X64_TARGET: "x86_64-apple-darwin"

tasks:
  info:
    desc: "Show Tauri build configuration"
    cmds:
      - |
        cat << EOF
        Tauri Build Configuration:
          App Name: {{.APP_NAME}}
          Version: {{.APP_VERSION}}
          Bundle ID: {{.BUNDLE_ID}}
          Tauri Directory: {{.TAURI_DIR}}

        macOS targets (tauri:*):
          - build:arm64     Build for Apple Silicon (arm64)
          - build:x64       Build for Intel (x86_64)
          - build           Build for current architecture
          - dev             Run development mode (nightly, ~10% faster)
          - dev:stable      Run development mode (stable toolchain)

        iOS targets (ios:*):
          - init            Initialize iOS project
          - dev             Run on iOS simulator
          - dev:device      Run on physical iOS device
          - build           Build for iOS distribution
          - build:sim       Build for iOS Simulator
          - build:appstore  Build for App Store Connect
          - certificates    Sync code signing certificates
          - testflight      Build and upload to TestFlight
          - release         Build and upload to App Store
          - clean           Clean iOS build artifacts

        Android targets (android:*):
          - init            Initialize Android project
          - dev             Run on Android emulator
          - dev:device      Run on physical Android device
          - build           Build for Android distribution (APK + AAB)
          - build:apk       Build APK only (for testing)
          - build:aab       Build AAB only (for Google Play)
          - testflight      Build and upload to Google Play beta
          - release         Build and upload to Google Play production
          - clean           Clean Android build artifacts

        Utilities (tauri:*):
          - icons           Generate app icons from logo
          - clean           Clean all build artifacts
          - clean:rust      Clean only Rust build artifacts
          - doctor          Check environment

        Output locations:
          - macOS app: {{.TAURI_DIR}}/target/*/release/bundle/macos/{{.APP_NAME}}.app
          - DMG: {{.TAURI_DIR}}/target/*/release/bundle/dmg/{{.APP_NAME}}_*.dmg
          - iOS: {{.TAURI_DIR}}/gen/apple/
          - Android APK: {{.TAURI_DIR}}/gen/android/app/build/outputs/apk/
          - Android AAB: {{.TAURI_DIR}}/gen/android/app/build/outputs/bundle/
        EOF
    silent: true

  _build:
    internal: true
    desc: "Internal task to build Tauri app"
    vars:
      TARGET: '{{.TARGET | default ""}}'
      TARGET_FLAG: '{{if .TARGET}}--target {{.TARGET}}{{end}}'
    cmds:
      - |
        echo "Building {{.APP_NAME}} v{{.APP_VERSION}}{{if .TARGET}} for {{.TARGET}}{{end}}..."
        cd {{.TAURI_DIR}} && npx tauri build {{.TARGET_FLAG}}

  build:
    desc: "Build Tauri app for current architecture"
    deps: [":npm:install"]
    vars:
      CURRENT_TARGET: '{{if eq ARCH "arm64"}}{{.MACOS_ARM64_TARGET}}{{else}}{{.MACOS_X64_TARGET}}{{end}}'
    cmds:
      - task: _build
        vars:
          TARGET: "{{.CURRENT_TARGET}}"
    sources:
      - "{{.TAURI_DIR}}/src/**/*.rs"
      - "{{.TAURI_DIR}}/Cargo.toml"
      - "{{.TAURI_DIR}}/tauri.conf.json"
      - "{{.TAURI_DIR}}/dist/**/*"

  build:arm64:
    desc: "Build Tauri app for Apple Silicon (arm64)"
    deps: [":npm:install"]
    cmds:
      - task: _build
        vars:
          TARGET: "{{.MACOS_ARM64_TARGET}}"
    sources:
      - "{{.TAURI_DIR}}/src/**/*.rs"
      - "{{.TAURI_DIR}}/Cargo.toml"
      - "{{.TAURI_DIR}}/tauri.conf.json"
      - "{{.TAURI_DIR}}/dist/**/*"

  build:x64:
    desc: "Build Tauri app for Intel (x86_64)"
    deps: [":npm:install"]
    cmds:
      - task: _build
        vars:
          TARGET: "{{.MACOS_X64_TARGET}}"
    sources:
      - "{{.TAURI_DIR}}/src/**/*.rs"
      - "{{.TAURI_DIR}}/Cargo.toml"
      - "{{.TAURI_DIR}}/tauri.conf.json"
      - "{{.TAURI_DIR}}/dist/**/*"

  dev:
    desc: "Run Tauri in development mode (uses nightly + parallel frontend)"
    deps: [":npm:install"]
    env:
      RUSTUP_TOOLCHAIN: nightly
      RUSTFLAGS: "-Z threads=8"
    cmds:
      - cmd: cd {{.TAURI_DIR}} && npx tauri dev
        ignore_error: true
    interactive: true

  dev:stable:
    desc: "Run Tauri in development mode (stable toolchain)"
    deps: [":npm:install"]
    cmds:
      - cmd: cd {{.TAURI_DIR}} && npx tauri dev
        ignore_error: true
    interactive: true

  icons:
    desc: "Generate app icons from source icon"
    cmds:
      - cd {{.TAURI_DIR}} && npx tauri icon icons/icon.png
    sources:
      - "{{.TAURI_DIR}}/icons/icon.png"
    generates:
      - "{{.TAURI_DIR}}/icons/*.icns"
      - "{{.TAURI_DIR}}/icons/*.ico"
      - "{{.TAURI_DIR}}/icons/*.png"
      - "{{.TAURI_DIR}}/gen/apple/Assets.xcassets/AppIcon.appiconset/*.png"

  clean:
    desc: "Clean Tauri build artifacts"
    cmds:
      - rm -rf {{.TAURI_DIR}}/target
      - rm -rf {{.ROOT_DIR}}/build
      - rm -rf {{.ROOT_DIR}}/dist
    silent: true

  clean:rust:
    desc: "Clean only Rust build artifacts"
    cmds:
      - cargo clean --manifest-path {{.TAURI_DIR}}/Cargo.toml
    silent: true

  test-app:
    desc: "Launch the built macOS app"
    vars:
      APP_PATH: "{{.TAURI_DIR}}/target/{{.MACOS_ARM64_TARGET}}/release/bundle/macos/{{.APP_NAME}}.app"
    cmds:
      - open "{{.APP_PATH}}"
    preconditions:
      - test -d "{{.APP_PATH}}"

  check-deps:
    desc: "Check if Tauri dependencies are installed"
    cmds:
      - |
        echo "Checking Tauri dependencies..."
        missing=0

        if ! command -v cargo &> /dev/null; then
          echo "cargo not found. Install Rust from https://rustup.rs"
          missing=1
        else
          echo "cargo version: $(cargo --version)"
        fi

        if ! command -v npx &> /dev/null; then
          echo "npx not found. Install Node.js from https://nodejs.org"
          missing=1
        else
          echo "npx available"
        fi

        if [[ $missing -eq 0 ]]; then
          echo "All dependencies satisfied"
        else
          exit 1
        fi
    silent: true

  doctor:
    desc: "Run Tauri doctor to check environment"
    cmds:
      - cd {{.TAURI_DIR}} && npx tauri info

  test:
    desc: "Run Rust tests"
    cmds:
      - cargo nextest run --manifest-path {{.TAURI_DIR}}/Cargo.toml
