version: "3.0"

set: ['e', 'u', 'pipefail']
shopt: ['globstar']

env:
  CARGO_HOME: "{{.ROOT_DIR}}/.cache/cargo"
  CARGO_TARGET_DIR: "{{.ROOT_DIR}}/src-tauri/target"
  ANDROID_HOME: '{{.ANDROID_HOME | default "/opt/homebrew/share/android-commandlinetools"}}'
  ANDROID_NDK_HOME: '{{.ANDROID_NDK_HOME | default "/opt/homebrew/share/android-commandlinetools/ndk/28.2.13676358"}}'

vars:
  APP_NAME: '{{.APP_NAME | default "Lunch"}}'
  APP_VERSION: '{{.APP_VERSION | default "0.9.0"}}'
  BUNDLE_ID: '{{.BUNDLE_ID | default "com.lunch.desktop"}}'
  TAURI_DIR: "{{.ROOT_DIR}}/src-tauri"
  MACOS_ARM64_TARGET: "aarch64-apple-darwin"
  MACOS_X64_TARGET: "x86_64-apple-darwin"
  IOS_ARM64_TARGET: "aarch64-apple-ios"
  IOS_SIM_ARM64_TARGET: "aarch64-apple-ios-sim"
  IOS_SIM_X64_TARGET: "x86_64-apple-ios"
  IOS_SIM_DEVICE: '{{.IOS_SIM_DEVICE | default "iPhone 13 mini"}}'
  ANDROID_EMULATOR: '{{.ANDROID_EMULATOR | default "pixel_7"}}'
  ANDROID_ARM64_TARGET: "aarch64-linux-android"
  ANDROID_ARMV7_TARGET: "armv7-linux-androideabi"
  ANDROID_X86_TARGET: "i686-linux-android"
  ANDROID_X64_TARGET: "x86_64-linux-android"

tasks:
  info:
    desc: "Show Tauri build configuration"
    cmds:
      - |
        cat << EOF
        Tauri Build Configuration:
          App Name: {{.APP_NAME}}
          Version: {{.APP_VERSION}}
          Bundle ID: {{.BUNDLE_ID}}
          Tauri Directory: {{.TAURI_DIR}}

        macOS targets:
          - build:arm64     Build for Apple Silicon (arm64)
          - build:x64       Build for Intel (x86_64)
          - build           Build for current architecture
          - dev             Run development mode (nightly, ~10% faster)
          - dev:stable      Run development mode (stable toolchain)

        iOS targets:
          - ios:init        Initialize iOS project
          - ios:dev         Run on iOS simulator
          - ios:dev:device  Run on physical iOS device
          - ios:build       Build for iOS distribution

        Android targets:
          - android:init        Initialize Android project
          - android:dev         Run on Android emulator
          - android:dev:device  Run on physical Android device
          - android:build       Build for Android distribution (APK + AAB)
          - android:build:apk   Build APK only (for testing)
          - android:build:aab   Build AAB only (for Google Play)

        Utilities:
          - icons           Generate app icons from logo
          - clean           Clean all build artifacts
          - doctor          Check environment

        Output locations:
          - macOS app: {{.TAURI_DIR}}/target/*/release/bundle/macos/{{.APP_NAME}}.app
          - DMG: {{.TAURI_DIR}}/target/*/release/bundle/dmg/{{.APP_NAME}}_*.dmg
          - iOS: {{.TAURI_DIR}}/gen/apple/
          - Android APK: {{.TAURI_DIR}}/gen/android/app/build/outputs/apk/
          - Android AAB: {{.TAURI_DIR}}/gen/android/app/build/outputs/bundle/
        EOF
    silent: true

  _build:
    internal: true
    desc: "Internal task to build Tauri app"
    vars:
      TARGET: '{{.TARGET | default ""}}'
      TARGET_FLAG: '{{if .TARGET}}--target {{.TARGET}}{{end}}'
    cmds:
      - |
        echo "Building {{.APP_NAME}} v{{.APP_VERSION}}{{if .TARGET}} for {{.TARGET}}{{end}}..."
        cd {{.TAURI_DIR}} && npx tauri build {{.TARGET_FLAG}}

  build:
    desc: "Build Tauri app for current architecture"
    deps: [":npm:install"]
    vars:
      CURRENT_TARGET: '{{if eq ARCH "arm64"}}{{.MACOS_ARM64_TARGET}}{{else}}{{.MACOS_X64_TARGET}}{{end}}'
    cmds:
      - task: _build
        vars:
          TARGET: "{{.CURRENT_TARGET}}"
    sources:
      - "{{.TAURI_DIR}}/src/**/*.rs"
      - "{{.TAURI_DIR}}/Cargo.toml"
      - "{{.TAURI_DIR}}/tauri.conf.json"
      - "{{.TAURI_DIR}}/dist/**/*"

  build:arm64:
    desc: "Build Tauri app for Apple Silicon (arm64)"
    deps: [":npm:install"]
    cmds:
      - task: _build
        vars:
          TARGET: "{{.MACOS_ARM64_TARGET}}"
    sources:
      - "{{.TAURI_DIR}}/src/**/*.rs"
      - "{{.TAURI_DIR}}/Cargo.toml"
      - "{{.TAURI_DIR}}/tauri.conf.json"
      - "{{.TAURI_DIR}}/dist/**/*"

  build:x64:
    desc: "Build Tauri app for Intel (x86_64)"
    deps: [":npm:install"]
    cmds:
      - task: _build
        vars:
          TARGET: "{{.MACOS_X64_TARGET}}"
    sources:
      - "{{.TAURI_DIR}}/src/**/*.rs"
      - "{{.TAURI_DIR}}/Cargo.toml"
      - "{{.TAURI_DIR}}/tauri.conf.json"
      - "{{.TAURI_DIR}}/dist/**/*"

  dev:
    desc: "Run Tauri in development mode (uses nightly + parallel frontend)"
    deps: [":npm:install"]
    env:
      RUSTUP_TOOLCHAIN: nightly
      RUSTFLAGS: "-Z threads=8"
    cmds:
      - cmd: cd {{.TAURI_DIR}} && npx tauri dev
        ignore_error: true
    interactive: true

  dev:stable:
    desc: "Run Tauri in development mode (stable toolchain)"
    deps: [":npm:install"]
    cmds:
      - cmd: cd {{.TAURI_DIR}} && npx tauri dev
        ignore_error: true
    interactive: true

  ios:init:
    desc: "Initialize iOS project"
    deps: [":npm:install"]
    cmds:
      - |
        echo "Adding iOS Rust targets..."
        rustup target add {{.IOS_ARM64_TARGET}} {{.IOS_SIM_X64_TARGET}} {{.IOS_SIM_ARM64_TARGET}}
        echo "Initializing iOS project..."
        cd {{.TAURI_DIR}} && npx tauri ios init
    status:
      - test -d {{.TAURI_DIR}}/gen/apple

  ios:boot:
    desc: "Boot iOS simulator"
    cmds:
      - xcrun simctl boot "{{.IOS_SIM_DEVICE}}" 2>/dev/null || true
    silent: true

  ios:dev:
    desc: "Run on iOS simulator"
    deps: [":npm:install", "ios:init", "ios:boot"]
    cmds:
      - cmd: cd {{.TAURI_DIR}} && npx tauri ios dev "{{.IOS_SIM_DEVICE}}"
        ignore_error: true
    interactive: true

  ios:dev:device:
    desc: "Run on physical iOS device"
    deps: [":npm:install", "ios:init"]
    cmds:
      - cmd: cd {{.TAURI_DIR}} && npx tauri ios dev --open --host
        ignore_error: true
    interactive: true

  ios:build:
    desc: "Build for iOS distribution (requires device/provisioning)"
    deps: [":npm:install", "ios:init"]
    cmds:
      - cd {{.TAURI_DIR}} && npx tauri ios build

  ios:build:sim:
    desc: "Build for iOS Simulator (no provisioning required)"
    deps: [":npm:install", "ios:init"]
    cmds:
      - |
        echo "Building for iOS Simulator..."
        cd {{.TAURI_DIR}}
        xcodebuild -scheme lunch_iOS \
          -workspace gen/apple/lunch.xcodeproj/project.xcworkspace/ \
          -sdk iphonesimulator \
          -configuration debug \
          -destination 'platform=iOS Simulator,name={{.IOS_SIM_DEVICE}},OS=18.6' \
          build

  ios:build:appstore:
    desc: "Build for App Store Connect"
    deps: [":npm:install", "ios:init"]
    cmds:
      - cd {{.TAURI_DIR}} && npx tauri ios build --export-method app-store-connect

  android:init:
    desc: "Initialize Android project"
    deps: [":npm:install"]
    cmds:
      - |
        echo "Adding Android Rust targets..."
        rustup target add {{.ANDROID_ARM64_TARGET}} {{.ANDROID_ARMV7_TARGET}} {{.ANDROID_X86_TARGET}} {{.ANDROID_X64_TARGET}}
        echo "Initializing Android project..."
        cd {{.TAURI_DIR}} && npx tauri android init
    status:
      - test -d {{.TAURI_DIR}}/gen/android

  android:dev:
    desc: "Run on Android emulator"
    deps: [":npm:install", "android:init"]
    cmds:
      - cmd: cd {{.TAURI_DIR}} && npx tauri android dev "{{.ANDROID_EMULATOR}}"
        ignore_error: true
    interactive: true

  android:dev:device:
    desc: "Run on physical Android device"
    deps: [":npm:install", "android:init"]
    cmds:
      - cmd: cd {{.TAURI_DIR}} && npx tauri android dev --open --host
        ignore_error: true
    interactive: true

  android:build:
    desc: "Build for Android distribution (APK and AAB)"
    deps: [":npm:install", "android:init"]
    cmds:
      - cd {{.TAURI_DIR}} && npx tauri android build

  android:build:apk:
    desc: "Build APK only (for testing/sideloading)"
    deps: [":npm:install", "android:init"]
    cmds:
      - cd {{.TAURI_DIR}} && npx tauri android build --apk

  android:build:aab:
    desc: "Build AAB only (for Google Play)"
    deps: [":npm:install", "android:init"]
    cmds:
      - cd {{.TAURI_DIR}} && npx tauri android build --aab

  android:testflight:
    desc: "Build and upload to Google Play beta track"
    deps: [":npm:install", "android:init", "icons", ":bundle:install"]
    sources:
      - "{{.TAURI_DIR}}/src/**/*.rs"
      - "{{.TAURI_DIR}}/Cargo.toml"
      - "{{.TAURI_DIR}}/Cargo.lock"
      - "{{.TAURI_DIR}}/tauri.conf.json"
      - "{{.TAURI_DIR}}/dist/**/*"
      - "{{.TAURI_DIR}}/icons/icon.png"
      - "{{.ROOT_DIR}}/fastlane/Fastfile"
      - "{{.ROOT_DIR}}/fastlane/Appfile"
    generates:
      - "{{.TAURI_DIR}}/gen/android/app/build/outputs/bundle/release/*.aab"
    method: checksum
    cmds:
      - bundle exec fastlane android beta

  android:release:
    desc: "Build and upload to Google Play production"
    deps: [":bundle:install"]
    cmds:
      - bundle exec fastlane android release

  icons:
    desc: "Generate app icons from source icon"
    cmds:
      - cd {{.TAURI_DIR}} && npx tauri icon icons/icon.png
    sources:
      - "{{.TAURI_DIR}}/icons/icon.png"
    generates:
      - "{{.TAURI_DIR}}/icons/*.icns"
      - "{{.TAURI_DIR}}/icons/*.ico"
      - "{{.TAURI_DIR}}/icons/*.png"
      - "{{.TAURI_DIR}}/gen/apple/Assets.xcassets/AppIcon.appiconset/*.png"

  clean:
    desc: "Clean Tauri build artifacts"
    cmds:
      - rm -rf {{.TAURI_DIR}}/target
      - rm -rf {{.ROOT_DIR}}/build
      - rm -rf {{.ROOT_DIR}}/dist
    silent: true

  clean:rust:
    desc: "Clean only Rust build artifacts"
    cmds:
      - cargo clean --manifest-path {{.TAURI_DIR}}/Cargo.toml
    silent: true

  clean:ios:
    desc: "Clean iOS build artifacts"
    cmds:
      - rm -rf {{.TAURI_DIR}}/gen/apple/build
    silent: true

  clean:android:
    desc: "Clean Android build artifacts"
    cmds:
      - rm -rf {{.TAURI_DIR}}/gen/android/build
      - rm -rf {{.TAURI_DIR}}/gen/android/app/build
      - rm -rf {{.TAURI_DIR}}/gen/android/.gradle
    silent: true

  test-app:
    desc: "Launch the built macOS app"
    vars:
      APP_PATH: "{{.TAURI_DIR}}/target/{{.MACOS_ARM64_TARGET}}/release/bundle/macos/{{.APP_NAME}}.app"
    cmds:
      - open "{{.APP_PATH}}"
    preconditions:
      - test -d "{{.APP_PATH}}"

  check-deps:
    desc: "Check if Tauri dependencies are installed"
    cmds:
      - |
        echo "Checking Tauri dependencies..."
        missing=0

        if ! command -v cargo &> /dev/null; then
          echo "cargo not found. Install Rust from https://rustup.rs"
          missing=1
        else
          echo "cargo version: $(cargo --version)"
        fi

        if ! command -v npx &> /dev/null; then
          echo "npx not found. Install Node.js from https://nodejs.org"
          missing=1
        else
          echo "npx available"
        fi

        if [[ $missing -eq 0 ]]; then
          echo "All dependencies satisfied"
        else
          exit 1
        fi
    silent: true

  doctor:
    desc: "Run Tauri doctor to check environment"
    cmds:
      - cd {{.TAURI_DIR}} && npx tauri info

  ios:certificates:
    desc: "Sync code signing certificates"
    deps: [":bundle:install"]
    cmds:
      - bundle exec fastlane certificates

  ios:testflight:
    desc: "Build and upload to TestFlight"
    deps: [":npm:install", "ios:init", "icons", ":bundle:install"]
    sources:
      - "{{.TAURI_DIR}}/src/**/*.rs"
      - "{{.TAURI_DIR}}/Cargo.toml"
      - "{{.TAURI_DIR}}/Cargo.lock"
      - "{{.TAURI_DIR}}/tauri.conf.json"
      - "{{.TAURI_DIR}}/dist/**/*"
      - "{{.TAURI_DIR}}/icons/icon.png"
      - "{{.ROOT_DIR}}/fastlane/Fastfile"
      - "{{.ROOT_DIR}}/fastlane/Appfile"
    generates:
      - "{{.TAURI_DIR}}/gen/apple/build/**/*.ipa"
    method: checksum
    cmds:
      - bundle exec fastlane beta

  ios:release:
    desc: "Build and upload to App Store"
    deps: [":bundle:install"]
    cmds:
      - bundle exec fastlane release

  test:
    desc: "Run Rust tests"
    cmds:
      - cargo nextest run --manifest-path {{.TAURI_DIR}}/Cargo.toml
